#!/usr/bin/env node --unhandled-rejections=strict
/* eslint-disable */
// prettier-ignore
(()=>{var _e=Object.create,G=Object.defineProperty,Re=Object.getPrototypeOf,Te=Object.prototype.hasOwnProperty,ve=Object.getOwnPropertyNames,$e=Object.getOwnPropertyDescriptor;var Ae=e=>G(e,"__esModule",{value:!0});var Le=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Ce=(e,t,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ve(t))!Te.call(e,r)&&r!=="default"&&G(e,r,{get:()=>t[r],enumerable:!(o=$e(t,r))||o.enumerable});return e},p=e=>Ce(Ae(G(e!=null?_e(Re(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var oe=Le(z=>{function T(e,t){if(typeof e=="string")return e;if(e){let o,r;if(Array.isArray(e)){for(o=0;o<e.length;o++)if(r=T(e[o],t))return r}else for(o in e)if(t.has(o))return T(e[o],t)}}function x(e,t,o){throw new Error(o?`No known conditions for "${t}" entry in "${e}" package`:`Missing "${t}" export in "${e}" package`)}function re(e,t){return t===e?".":t[0]==="."?t:t.replace(new RegExp("^"+e+"/"),"./")}function Fe(e,t=".",o={}){let{name:r,exports:n}=e;if(n){let{browser:a,require:l,conditions:s=[]}=o,i=re(r,t);if(i[0]!=="."&&(i="./"+i),typeof n=="string")return i==="."?n:x(r,i);let c=new Set(["default",...s]);c.add(l?"require":"import"),c.add(a?"browser":"node");let u,P,X=!1;for(u in n){X=u[0]!==".";break}if(X)return i==="."?T(n,c)||x(r,i,1):x(r,i);if(P=n[i])return T(P,c)||x(r,i,1);for(u in n){if(P=u[u.length-1],P==="/"&&i.startsWith(u))return(P=T(n[u],c))?P+i.substring(u.length):x(r,i,1);if(P==="*"&&i.startsWith(u.slice(0,-1))&&i.substring(u.length-1).length>0)return(P=T(n[u],c))?P.replace("*",i.substring(u.length-1)):x(r,i,1)}return x(r,i)}}function He(e,t={}){let o=0,r,n=t.browser,a=t.fields||["module","main"];for(n&&!a.includes("browser")&&a.unshift("browser");o<a.length;o++)if(r=e[a[o]]){if(typeof r!="string")if(typeof r=="object"&&a[o]=="browser"){if(typeof n=="string"&&(r=r[n=re(e.name,n)],r==null))return n}else continue;return typeof r=="string"?"./"+r.replace(/^\.?\//,""):r}}z.legacy=He;z.resolve=Fe});var f=p(require("path")),K=p(require("esbuild"));var j=p(require("path")),le=p(require("@mdx-js/mdx")),ce=p(require("sass"));var m=p(require("fs")),w=p(require("path")),R=(e,t)=>o=>o?t(o):e(),F=e=>new Promise((t,o)=>(0,m.readdir)(e,(r,n)=>r?o(r):t(n))),Z=async e=>Promise.all((await F(e)).flatMap(async t=>{let o=(0,w.join)(e,t);return await U(o)?[o,...await Z(o)]:[o]})).then(t=>t.flat()),J=async(e,t)=>{await g(t),await Y(t),await Promise.all((await F(e)).map(async o=>{let r=(0,w.join)(e,o),n=(0,w.join)(t,o);await U(r)?await J(r,n):await H(r,n)}))},H=(e,t)=>new Promise((o,r)=>(0,m.copyFile)(e,t,R(o,r))),Y=async e=>{let t=await F(e);await Promise.all(t.map(o=>L((0,w.join)(e,o))))},g=e=>new Promise((t,o)=>(0,m.mkdir)(e,{recursive:!0},R(t,o))),U=e=>new Promise((t,o)=>(0,m.lstat)(e,(r,n)=>r?o(r):t(n.isDirectory()))),ee=async(e,t)=>t?(await Z(e)).map(o=>(0,w.relative)(e,o)).sort((o,r)=>o.localeCompare(r)):F(e),te=e=>new Promise((t,o)=>(0,m.readFile)(e,(r,n)=>r?o(r):t(n.toString()))),L=e=>new Promise((t,o)=>{m.readFile!=null?(0,m.rm)(e,{recursive:!0,force:!0},R(t,o)):U(e).then(r=>r?(0,m.rmdir)(e,{recursive:!0},R(t,o)):(0,m.unlink)(e,R(t,o))).catch(r=>o(r))}),y=(e,t)=>new Promise((o,r)=>(0,m.writeFile)(e,t,R(o,r)));var ie=p(require("fs"));var D=p(require("fs")),d=p(require("path")),N=p(oe()),De=[".tsx",".ts",".jsx",".mjs",".cjs",".js",".json"],Ne=/^(\/|\.{1,2}(\/|$))/,je=/^\.{0,2}\//,ke=(e,t,o)=>{let r=(0,N.resolve)(e,t,{browser:o,require:!o});if(r!=null)return r;if(t!==".")return null;let n=(0,N.legacy)(e,o?{browser:o}:{browser:!1,fields:["main","module"]});return typeof n=="string"?n:null},Be=(e,t)=>{let o=(0,d.normalize)(e),r=(0,d.normalize)(t);return o===r?".":(o.endsWith(d.sep)||(o=o+d.sep),r.startsWith(o)?r.slice(o.length):null)},Me=(e,t,o)=>{let r=t.findPackageLocator((0,d.join)(e,"internal.js"));if(r==null)throw new Error;let{packageLocation:n}=t.getPackageInformation(r),a=(0,d.join)(n,"package.json");if(!D.existsSync(a))return null;let l=JSON.parse(D.readFileSync(a,"utf8")),s=Be(n,e);if(s==null)throw new Error;je.test(s)||(s=`./${s}`),s=(0,d.normalize)(s);let i=ke(l,s,o);return i!=null?(0,d.join)(n,i):null},We=(e,t,o,r)=>{if(Ne.test(e))return t;let n=Me(t,o,r);return n?(0,d.normalize)(n):t},Oe=(e,t,o,r)=>{let n=o.resolveToUnqualified(e,t);return n==null?null:o.resolveUnqualified(We(e,n,o,r),{extensions:De})},ne=Oe;var se=/()/,Ie=()=>({name:"esbuild-scripts-esbuild-plugin-pnp",setup(e){let{findPnpApi:t}=require("module");if(typeof t=="undefined")return;let o=process.cwd();e.onResolve({filter:se},async r=>{let n=r.importer?r.importer:`${o}/`,a=t(n);if(!a)return;let l=ne(r.path,n,a,e.initialOptions.platform!=="node");return l==null?{external:!0}:{namespace:"pnp",path:l}}),e.onLoad!==null&&e.onLoad({filter:se},async r=>({contents:await ie.promises.readFile(r.path,"utf8"),loader:"default"}))}}),ae=Ie;var Ge={name:"WebAppResolvePlugin",setup(e){e.onResolve({filter:/data:/},()=>({external:!0})),e.onResolve({filter:/stream/},()=>({path:"NODE_BUILTIN_STREAM",namespace:"shimmed-node-builtin"})),e.onLoad({filter:/NODE_BUILTIN_STREAM/,namespace:"shimmed-node-builtin"},()=>({contents:"export function Readable(){};export function Writable(){};export default {Readable,Writable};"})),e.onResolve({filter:/fs/},()=>({path:"NODE_BUILTIN_FS",namespace:"shimmed-node-builtin"})),e.onLoad({filter:/NODE_BUILTIN_FS/,namespace:"shimmed-node-builtin"},()=>({contents:"export {};"}))}},Ue={name:"sass",setup(e){e.onResolve({filter:/.\.(scss|sass)$/},async t=>({path:(0,j.resolve)((0,j.dirname)(t.importer),t.path)})),e.onLoad({filter:/.\.(scss|sass)$/},async t=>{let{css:o}=await new Promise((r,n)=>{(0,ce.render)({file:t.path},(a,l)=>{a?n(a):r(l)})});return{contents:o.toString(),loader:"css",watchFiles:[t.path]}})}},Je={name:"mdx",setup(e){e.onLoad({filter:/\.mdx?$/},async t=>{let o=await te(t.path);return{contents:`import React from'react';
import mdx from'esbuild-scripts/__internal-components__/mdx';
${await(0,le.default)(o)}`,loader:"jsx"}})}},Ye=[Ge,Ue,Je,ae()],me=Ye;var ze=({isServer:e=!1,isProd:t=!1})=>({define:{__SERVER__:String(e),"process.env.NODE_ENV":t?'"production"':'"development"'},bundle:!0,minify:!1,legalComments:"linked",platform:"browser",target:"es2019",logLevel:"error",plugins:me}),C=ze;var E=p(require("path")),q=(0,E.join)(__dirname,"templates"),b=".temp",k=(0,E.join)(".temp","__server__.jsx"),S=(0,E.join)("src","pages"),B=(0,E.join)("build","__ssr.jsx"),ue=(0,E.join)("build","__ssr.jsx.LEGAL.txt"),pe=(0,E.join)("build","__ssr.css"),V="build";var h=p(require("path"));var de="// @generated",fe=e=>e.endsWith("index")?e.substring(0,e.length-(e.endsWith("/index")?6:5)):e,qe=(e,t)=>{let o=fe(e),r=t.filter(i=>i!==e).map(fe),n=(0,h.join)((0,h.relative)((0,h.dirname)(e),".."),"src","pages"),a=r.map((i,c)=>`const Component${c} = lazy(() => import('${n}/${i}'));`).join(""),l=r.map((i,c)=>`<Route exact path="/${i}"><Suspense fallback={null}><Component${c} /></Suspense></Route>`).join(""),s=`<Switch><Route exact path="/${o}"><Page /></Route>${l}</Switch>`;return`${de}
import React,{Suspense,lazy}from'react';import{hydrate,render}from'react-dom';
import {BrowserRouter,Route,Switch}from'esbuild-scripts/__internal-components__/react-router';
import Document from '${n}/_document.tsx';import Page from '${n}/${o}';${a}
const element = <BrowserRouter><Document>${s}</Document></BrowserRouter>;const rootElement = document.getElementById('root');
if (rootElement.hasChildNodes()) hydrate(element, rootElement); else render(element, rootElement);
`},Ve=e=>`${de}
import React from 'react';
import {renderToString} from'react-dom/server';
import Helmet from 'esbuild-scripts/components/Head';
import {StaticRouter}from'esbuild-scripts/__internal-components__/react-router';
import Document from '../src/pages/_document.tsx';
${e.map((t,o)=>`import Page${o} from '../src/pages/${t}';`).join(`
`)}
const map = { ${e.map((t,o)=>`'${t}': Page${o}`).join(", ")} };
module.exports = (path) => ({
  divHTML: renderToString(
    <StaticRouter location={'/'+path}>
      <Document>{React.createElement(map[path])}</Document>
    </StaticRouter>
  ),
  noJS: map[path].noJS,
  helmet: Helmet.renderStatic(),
});
`,Ke=async()=>(await g(S),(await ee(S,!0)).map(t=>{switch((0,h.extname)(t)){case".js":case".jsx":case".ts":case".tsx":break;default:return null}return t.substring(0,t.lastIndexOf("."))}).filter(t=>t!=null&&!t.startsWith("_document"))),M=async()=>{let e=await Ke();return await g(b),await Y(b),await Promise.all([...e.map(async t=>{let o=(0,h.join)(b,`${t}.jsx`);await g((0,h.dirname)(o)),await y(o,qe(t,e))}),y(k,Ve(e))]),e};var Qe=(e,t)=>t?`<script type="module" src="/${e}"></script>`:`<script src="/${e}"></script>`,Xe=(e,t)=>`<link rel="${t?"modulepreload":"preload"}" href="/${e}" />`,Ze=(e,t,o)=>{let r=[],n=[];e.forEach(s=>{!o&&s.endsWith("js")?r.push(s):s.endsWith("css")&&n.push(s)});let a=n.map(s=>`<link rel="stylesheet" href="/${s}" />`).join("")+r.map(s=>Xe(s,t)).join(""),l=r.map(s=>Qe(s,t)).join("");return{headLinks:a,bodyScriptLinks:l}},ge=(e,t)=>t==null?`<head>${e}</head>`:`<head>${[t.meta.toString(),t.title.toString(),t.link.toString(),t.script.toString(),e].join("")}</head>`,et=(e,t,o)=>{let{headLinks:r,bodyScriptLinks:n}=Ze(t,o,e==null?void 0:e.noJS);if(e==null){let c=ge(r),u=`<body><div id="root"></div>${n}</body>`;return`<!DOCTYPE html><html>${c}${u}</html>`}let{divHTML:a,helmet:l}=e,s=ge(r,l),i=`<body><div id="root">${a}</div>${n}</body>`;return`<!DOCTYPE html><html ${l.htmlAttributes.toString()}>${s}${i}</html>`},W=et;var v=e=>process.stderr.isTTY?t=>`[${e}m${t}[0m`:t=>t,$=v(31),A=v(32),he=v(33),O=v(34),vt=v(35),$t=v(36);var Pe=async e=>{let{outputFiles:t}=await(0,K.build)({...C({isProd:!0}),entryPoints:e.map(r=>(0,f.join)(b,`${r}.jsx`)),assetNames:"assets/[name]-[hash]",chunkNames:"chunks/[name]-[hash]",entryNames:"[dir]/[name]-[hash]",minify:!0,format:"esm",splitting:!0,write:!1,outdir:"build"}),o=(0,f.resolve)("build");return await Promise.all(t.map(async r=>{await g((0,f.dirname)(r.path)),await y(r.path,r.contents)})),t.map(({path:r})=>(0,f.relative)(o,r))},tt=async()=>{await(0,K.build)({...C({isServer:!0,isProd:!0}),entryPoints:[k],platform:"node",format:"cjs",outfile:B});try{return require((0,f.resolve)(B))}catch(e){return console.error($("Unable to perform server side rendering since the server bundle is not correctly generated.")),console.error($(e)),null}finally{await Promise.all([L(B),L(ue),L(pe)])}},rt=async e=>{let t=new Date().getTime();console.error(he("[i] Bundling..."));let o=await M();await J("public","build");let r,n;if(e){if([r,n]=await Promise.all([Pe(o),tt()]),n==null)return!1}else r=await Pe(o),n=null;let a=o.map(s=>{let i=r.filter(u=>u.startsWith("chunk")||u.startsWith(s)),c=W(n==null?void 0:n(s),i,!0);return{entryPoint:s,html:c}});await Promise.all(a.map(async({entryPoint:s,html:i})=>{let c;s.endsWith("index")?c=(0,f.join)(V,`${s}.html`):c=(0,f.join)(V,s,"index.html"),await g((0,f.dirname)(c)),await y(c,i)}));let l=new Date().getTime()-t;return console.error(`\u26A1 ${A(`Build success in ${l}ms.`)}`),!0},Q=rt;var _=p(require("path"));var ot=async()=>{await g(S),await Promise.all([H((0,_.join)(q,"_document.tsx"),(0,_.join)(S,"_document.tsx")),H((0,_.join)(q,"index.tsx"),(0,_.join)(S,"index.tsx")),y((0,_.join)(S,"index.css"),""),y((0,_.join)("src","types.d.ts"),`/// <reference types="esbuild-scripts" />
`),g("public")]),console.error(A("esbuild-scripts app initialized."))},ye=ot;var I=p(require("http")),be=p(require("path")),Se=p(require("esbuild"));var nt=(e,t)=>{if(t==null||!t.startsWith("/"))return;let o=t.substring(1);return e.find(r=>r.endsWith("index")?[r,r.substring(0,r.length-5)].includes(o):r===o)},we=e=>W(void 0,[`${e}.js`,`${e}.css`],!1),it=async()=>{let e=await M(),t=await(0,Se.serve)({servedir:"public",port:19815},{...C({}),entryPoints:e.map(r=>(0,be.join)(b,`${r}.jsx`)),sourcemap:"inline",outdir:"public"}),o=(0,I.createServer)((r,n)=>{let a=nt(e,r.url);if(a!=null){n.writeHead(200,{"Content-Type":"text/html"}),n.end(we(a));return}let l={hostname:t.host,port:t.port,path:r.url,method:r.method,headers:r.headers},s=(0,I.request)(l,i=>{if(i.statusCode===404){n.writeHead(200,{"Content-Type":"text/html"}),n.end(we("index"));return}n.writeHead(i.statusCode||200,i.headers),i.pipe(n,{end:!0})});r.pipe(s,{end:!0})}).listen(3e3);console.error(`${A("Serving at")} ${O("http://localhost:3000")}`),await t.wait,o.close()},xe=it;function Ee(){console.error(O("Usage:")),console.error("- esbuild-script start: start the devserver."),console.error("- esbuild-script build: generate production build."),console.error("- esbuild-script ssg: generate static site."),console.error("- esbuild-script ssg --no-js: generate static site without JS."),console.error("- esbuild-script help: display command line usages.")}async function st(){let e=process.argv[2]||"";switch(e){case"init":return await ye(),!0;case"start":return await xe(),!0;case"ssg":return Q(!0);case"build":return Q(!1);case"help":case"--help":return Ee(),!0;default:return console.error($(`Unknown command: '${e}'`)),Ee(),!1}}async function at(){try{await st()||(process.exitCode=1)}catch(e){console.error($(e)),process.exitCode=1}}at();})();
