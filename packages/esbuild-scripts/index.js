#!/usr/bin/env node --unhandled-rejections=strict
/* eslint-disable */
// prettier-ignore
(()=>{var vt=Object.create,I=Object.defineProperty,Rt=Object.getPrototypeOf,At=Object.prototype.hasOwnProperty,Ct=Object.getOwnPropertyNames,jt=Object.getOwnPropertyDescriptor;var Ht=t=>I(t,"__esModule",{value:!0});var Lt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var Dt=(t,e,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ct(e))!At.call(t,r)&&r!=="default"&&I(t,r,{get:()=>e[r],enumerable:!(n=jt(e,r))||n.enumerable});return t},m=t=>Dt(Ht(I(t!=null?vt(Rt(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var it=Lt(z=>{function $(t,e){if(typeof t=="string")return t;if(t){let n,r;if(Array.isArray(t)){for(n=0;n<t.length;n++)if(r=$(t[n],e))return r}else for(n in t)if(e.has(n))return $(t[n],e)}}function x(t,e,n){throw new Error(n?`No known conditions for "${e}" entry in "${t}" package`:`Missing "${e}" export in "${t}" package`)}function ot(t,e){return e===t?".":e[0]==="."?e:e.replace(new RegExp("^"+t+"/"),"./")}function Ft(t,e=".",n={}){let{name:r,exports:o}=t;if(o){let{browser:a,require:c,conditions:s=[]}=n,i=ot(r,e);if(i[0]!=="."&&(i="./"+i),typeof o=="string")return i==="."?o:x(r,i);let u=new Set(["default",...s]);u.add(c?"require":"import"),u.add(a?"browser":"node");let p,b,et=!1;for(p in o){et=p[0]!==".";break}if(et)return i==="."?$(o,u)||x(r,i,1):x(r,i);if(b=o[i])return $(b,u)||x(r,i,1);for(p in o){if(b=p[p.length-1],b==="/"&&i.startsWith(p))return(b=$(o[p],u))?b+i.substring(p.length):x(r,i,1);if(b==="*"&&i.startsWith(p.slice(0,-1))&&i.substring(p.length-1).length>0)return(b=$(o[p],u))?b.replace("*",i.substring(p.length-1)):x(r,i,1)}return x(r,i)}}function kt(t,e={}){let n=0,r,o=e.browser,a=e.fields||["module","main"];for(o&&!a.includes("browser")&&a.unshift("browser");n<a.length;n++)if(r=t[a[n]]){if(typeof r!="string")if(typeof r=="object"&&a[n]=="browser"){if(typeof o=="string"&&(r=r[o=ot(t.name,o)],r==null))return o}else continue;return typeof r=="string"?"./"+r.replace(/^\.?\//,""):r}}z.legacy=kt;z.resolve=Ft});var P=m(require("path")),Z=m(require("esbuild"));var pt=m(require("module")),d=m(require("path")),dt=m(require("@mdx-js/mdx")),ft=m(require("sass"));var S=m(require("path")),J=(0,S.join)(__dirname,"templates"),w=".temp",D=(0,S.join)(".temp","__server__.jsx"),f=(0,S.join)("src","pages"),E=(0,S.join)("src","generated-pages"),F=(0,S.join)("build","__ssr.jsx"),rt=(0,S.join)("build","__ssr.jsx.LEGAL.txt"),nt=(0,S.join)("build","__ssr.css"),Y="build";var at=m(require("fs"));var k=m(require("fs")),g=m(require("path")),N=m(it()),Nt=[".tsx",".ts",".jsx",".mjs",".cjs",".js",".json"],Gt=/^(\/|\.{1,2}(\/|$))/,Mt=/^\.{0,2}\//,Bt=(t,e,n)=>{let r=(0,N.resolve)(t,e,{browser:n,require:!n});if(r!=null)return r;let o=(0,N.legacy)(t,n?{browser:n}:{browser:!1,fields:["main","module"]});return typeof o=="string"?e==="."?o:null:o&&(o[e]||o[`${e}.js`]||o[`./${e}`]||o[`./${e}.js`])||null},Wt=(t,e)=>{let n=(0,g.normalize)(t),r=(0,g.normalize)(e);return n===r?".":(n.endsWith(g.sep)||(n=n+g.sep),r.startsWith(n)?r.slice(n.length):null)},Ot=(t,e,n)=>{let r=e.findPackageLocator((0,g.join)(t,"internal.js"));if(r==null)throw new Error;let{packageLocation:o}=e.getPackageInformation(r),a=(0,g.join)(o,"package.json");if(!k.existsSync(a))return null;let c=JSON.parse(k.readFileSync(a,"utf8")),s=Wt(o,t);if(s==null)throw new Error;Mt.test(s)||(s=`./${s}`),s=(0,g.normalize)(s);let i=Bt(c,s,n);return i!=null?(0,g.join)(o,i):null},Ut=(t,e,n,r)=>{if(Gt.test(t))return e;let o=Ot(e,n,r);return o?(0,g.normalize)(o):e},It=(t,e,n,r)=>{let o=n.resolveToUnqualified(t,e);return o==null?null:n.resolveUnqualified(Ut(t,o,n,r),{extensions:Nt})},st=It;var lt=/()/,Jt=()=>({name:"esbuild-scripts-esbuild-plugin-pnp",setup(t){let{findPnpApi:e}=require("module");if(typeof e=="undefined")return;let n=process.cwd();t.onResolve({filter:lt},async r=>{let o=r.importer?r.importer:`${n}/`,a=e(o);if(!a)return;let c=st(r.path,o,a,t.initialOptions.platform!=="node");return c==null?{external:!0}:{namespace:"pnp",path:c}}),t.onLoad!==null&&t.onLoad({filter:lt},async r=>({contents:await at.promises.readFile(r.path,"utf8"),loader:"default"}))}}),ct=Jt;var l=m(require("fs")),_=m(require("path")),v=(t,e)=>n=>n?e(n):t(),G=t=>new Promise((e,n)=>(0,l.readdir)(t,(r,o)=>r?n(r):e(o))),ut=async t=>Promise.all((await G(t)).flatMap(async e=>{let n=(0,_.join)(t,e);return await q(n)?[n,...await ut(n)]:[n]})).then(e=>e.flat()),V=async(t,e)=>{await h(e),await K(e),await Promise.all((await G(t)).map(async n=>{let r=(0,_.join)(t,n),o=(0,_.join)(e,n);await q(r)?await V(r,o):await M(r,o)}))},M=(t,e)=>new Promise((n,r)=>(0,l.copyFile)(t,e,v(n,r))),K=async t=>{let e=await G(t);await Promise.all(e.map(n=>H((0,_.join)(t,n))))},h=t=>new Promise((e,n)=>(0,l.mkdir)(t,{recursive:!0},v(e,n))),Q=t=>new Promise(e=>(0,l.access)(t,void 0,n=>e(n==null))),q=t=>new Promise((e,n)=>(0,l.lstat)(t,(r,o)=>r?n(r):e(o.isDirectory()))),X=async(t,e)=>e?await Q(t)?(await ut(t)).map(n=>(0,_.relative)(t,n)).sort((n,r)=>n.localeCompare(r)):[]:G(t),mt=t=>new Promise((e,n)=>(0,l.readFile)(t,(r,o)=>r?n(r):e(o.toString()))),H=t=>new Promise((e,n)=>{l.readFile!=null?(0,l.rm)(t,{recursive:!0,force:!0},v(e,n)):q(t).then(r=>r?(0,l.rmdir)(t,{recursive:!0},v(e,n)):(0,l.unlink)(t,v(e,n))).catch(r=>n(r))}),y=(t,e)=>new Promise((n,r)=>(0,l.writeFile)(t,e,v(n,r)));var Yt={name:"WebAppResolvePlugin",setup(t){t.onResolve({filter:/^data:/},()=>({external:!0})),t.onResolve({filter:/^esbuild-scripts-internal\/page\//},async e=>{let n=(0,d.relative)((0,d.join)("esbuild-scripts-internal","page"),e.path),r=[(0,d.join)(f,`${n}.js`),(0,d.join)(f,`${n}.jsx`),(0,d.join)(f,`${n}.ts`),(0,d.join)(f,`${n}.tsx`),(0,d.join)(E,`${n}.js`),(0,d.join)(E,`${n}.jsx`),(0,d.join)(E,`${n}.ts`),(0,d.join)(E,`${n}.tsx`)];for(let o of r)if(await Q(o))return{path:(0,d.resolve)(o)};throw new Error(`Cannot found page at ${n}. Candidates considered:
${r.join(`
`)}`)})}},zt={name:"sass",setup(t){t.onResolve({filter:/.\.(scss|sass)$/},async e=>e.path.startsWith(".")?{path:(0,d.resolve)((0,d.dirname)(e.importer),e.path)}:{path:(0,pt.createRequire)(e.importer).resolve(e.path)}),t.onLoad({filter:/.\.(scss|sass)$/},async e=>{let{css:n}=await new Promise((r,o)=>{(0,ft.render)({file:e.path},(a,c)=>{a?o(a):r(c)})});return{contents:n.toString(),loader:"css",watchFiles:[e.path]}})}},qt={name:"mdx",setup(t){t.onLoad({filter:/\.mdx?$/},async e=>{let n=await mt(e.path);return{contents:`import React from'react';
import mdx from 'esbuild-scripts/__internal-components__/mdx';
${await(0,dt.default)(n)}`,loader:"jsx"}})}},Vt=[Yt,zt,qt,ct()],gt=Vt;var Kt=({isServer:t=!1,isProd:e=!1})=>({define:{__SERVER__:String(t),"process.env.NODE_ENV":e?'"production"':'"development"'},bundle:!0,minify:!1,legalComments:"linked",platform:"browser",target:"es2019",logLevel:"error",plugins:gt}),L=Kt;var R=m(require("path"));var Pt="// @generated",ht=t=>t.endsWith("index")?t.substring(0,t.length-(t.endsWith("/index")?6:5)):t,Qt=(t,e)=>{let n=ht(t),r=e.filter(i=>i!==t),o=r.map(ht),a=r.map((i,u)=>`const Component${u} = lazy(() => import('esbuild-scripts-internal/page/${i}'));`).join(`
`),c=o.map((i,u)=>`<Route exact path="/${i}"><Suspense fallback={null}><Component${u} /></Suspense></Route>`).join(""),s=`<Switch><Route exact path="/${n}"><Page /></Route>${c}</Switch>`;return`${Pt}
import React,{Suspense,lazy} from 'react';
import {hydrate,render} from 'react-dom';
import {BrowserRouter,Route,Switch} from 'esbuild-scripts/__internal-components__/react-router';
import Document from 'esbuild-scripts-internal/page/_document';
import Page from 'esbuild-scripts-internal/page/${t}';
${a}
const element = <BrowserRouter><Document>${s}</Document></BrowserRouter>;const rootElement = document.getElementById('root');
if (rootElement.hasChildNodes()) hydrate(element, rootElement); else render(element, rootElement);
`},Xt=t=>`${Pt}
import React from 'react';
import {renderToString} from 'react-dom/server';
import Helmet from 'esbuild-scripts/components/Head';
import {StaticRouter} from 'esbuild-scripts/__internal-components__/react-router';
import Document from 'esbuild-scripts-internal/page/_document';
${t.map((e,n)=>`import Page${n} from 'esbuild-scripts-internal/page/${e}';`).join(`
`)}
const map = { ${t.map((e,n)=>`'${e}': Page${n}`).join(", ")} };
module.exports = (path) => ({
  divHTML: renderToString(
    <StaticRouter location={'/'+path}>
      <Document>{React.createElement(map[path])}</Document>
    </StaticRouter>
  ),
  noJS: map[path].noJS,
  helmet: Helmet.renderStatic(),
});
`,Zt=async()=>{await h(f);let[t,e]=await Promise.all([X(f,!0),X(E,!0)]);return[...t,...e].map(r=>{switch((0,R.extname)(r)){case".js":case".jsx":case".ts":case".tsx":break;default:return null}return r.substring(0,r.lastIndexOf("."))}).filter(r=>r!=null&&!r.startsWith("_document"))},B=async()=>{let t=await Zt();return await h(w),await K(w),await Promise.all([...t.map(async e=>{let n=(0,R.join)(w,`${e}.jsx`);await h((0,R.dirname)(n)),await y(n,Qt(e,t))}),y(D,Xt(t))]),t};var te=(t,e)=>e?`<script type="module" src="/${t}"></script>`:`<script src="/${t}"></script>`,ee=(t,e)=>`<link rel="${e?"modulepreload":"preload"}" href="/${t}" />`,re=(t,e,n)=>{let r=[],o=[];t.forEach(s=>{!n&&s.endsWith("js")?r.push(s):s.endsWith("css")&&o.push(s)});let a=o.map(s=>`<link rel="stylesheet" href="/${s}" />`).join("")+r.map(s=>ee(s,e)).join(""),c=r.map(s=>te(s,e)).join("");return{headLinks:a,bodyScriptLinks:c}},bt=(t,e)=>e==null?`<head>${t}</head>`:`<head>${[e.meta.toString(),e.title.toString(),e.link.toString(),e.script.toString(),t].join("")}</head>`,ne=(t,e,n)=>{let{headLinks:r,bodyScriptLinks:o}=re(e,n,t==null?void 0:t.noJS);if(t==null){let u=bt(r),p=`<body><div id="root"></div>${o}</body>`;return`<!DOCTYPE html><html>${u}${p}</html>`}let{divHTML:a,helmet:c}=t,s=bt(r,c),i=`<body><div id="root">${a}</div>${o}</body>`;return`<!DOCTYPE html><html ${c.htmlAttributes.toString()}>${s}${i}</html>`},W=ne;var A=t=>process.stderr.isTTY?e=>`[${t}m${e}[0m`:e=>e,C=A(31),j=A(32),yt=A(33),O=A(34),je=A(35),He=A(36);var St=async t=>{let{outputFiles:e}=await(0,Z.build)({...L({isProd:!0}),entryPoints:t.map(r=>(0,P.join)(w,`${r}.jsx`)),assetNames:"assets/[name]-[hash]",chunkNames:"chunks/[name]-[hash]",entryNames:"[dir]/[name]-[hash]",minify:!0,format:"esm",splitting:!0,write:!1,outdir:"build"}),n=(0,P.resolve)("build");return await Promise.all(e.map(async r=>{await h((0,P.dirname)(r.path)),await y(r.path,r.contents)})),e.map(({path:r})=>(0,P.relative)(n,r))},oe=async()=>{await(0,Z.build)({...L({isServer:!0,isProd:!0}),entryPoints:[D],platform:"node",format:"cjs",outfile:F});try{return require((0,P.resolve)(F))}catch(t){return console.error(C("Unable to perform server side rendering since the server bundle is not correctly generated.")),console.error(C(t)),null}finally{await Promise.all([H(F),H(rt),H(nt)])}},ie=async t=>{let e=new Date().getTime();console.error(yt("[i] Bundling..."));let n=await B();await V("public","build");let r,o;if(t){if([r,o]=await Promise.all([St(n),oe()]),o==null)return!1}else r=await St(n),o=null;let a=n.map(s=>{let i=r.filter(p=>p.startsWith("chunk")||p.startsWith(s)),u=W(o==null?void 0:o(s),i,!0);return{entryPoint:s,html:u}});await Promise.all(a.map(async({entryPoint:s,html:i})=>{let u;s.endsWith("index")?u=(0,P.join)(Y,`${s}.html`):u=(0,P.join)(Y,s,"index.html"),await h((0,P.dirname)(u)),await y(u,i)}));let c=new Date().getTime()-e;return console.error(`\u26A1 ${j(`Build success in ${c}ms.`)}`),!0},tt=ie;var T=m(require("path"));var se=async()=>{await h(f),await Promise.all([M((0,T.join)(J,"_document.tsx"),(0,T.join)(f,"_document.tsx")),M((0,T.join)(J,"index.tsx"),(0,T.join)(f,"index.tsx")),y((0,T.join)(f,"index.css"),""),y((0,T.join)("src","types.d.ts"),`/// <reference types="esbuild-scripts" />
`),h("public")]),console.error(j("esbuild-scripts app initialized."))},wt=se;var U=m(require("http")),Et=m(require("path")),xt=m(require("esbuild"));var ae=(t,e)=>{if(e==null||!e.startsWith("/"))return;let n=e.substring(1);return t.find(r=>r.endsWith("index")?[r,r.substring(0,r.length-5)].includes(n):r===n)},_t=t=>W(void 0,[`${t}.js`,`${t}.css`],!1),le=async()=>{let t=await B(),e=await(0,xt.serve)({servedir:"public",port:19815},{...L({}),entryPoints:t.map(r=>(0,Et.join)(w,`${r}.jsx`)),sourcemap:"inline",outdir:"public"}),n=(0,U.createServer)((r,o)=>{let a=ae(t,r.url);if(a!=null){o.writeHead(200,{"Content-Type":"text/html"}),o.end(_t(a));return}let c={hostname:e.host,port:e.port,path:r.url,method:r.method,headers:r.headers},s=(0,U.request)(c,i=>{if(i.statusCode===404){o.writeHead(200,{"Content-Type":"text/html"}),o.end(_t("index"));return}o.writeHead(i.statusCode||200,i.headers),i.pipe(o,{end:!0})});r.pipe(s,{end:!0})}).listen(3e3);console.error(`${j("Serving at")} ${O("http://localhost:3000")}`),await e.wait,n.close()},Tt=le;function $t(){console.error(O("Usage:")),console.error("- esbuild-script start: start the devserver."),console.error("- esbuild-script build: generate production build."),console.error("- esbuild-script ssg: generate static site."),console.error("- esbuild-script ssg --no-js: generate static site without JS."),console.error("- esbuild-script help: display command line usages.")}async function ce(){let t=process.argv[2]||"";switch(t){case"init":return await wt(),!0;case"start":return await Tt(),!0;case"ssg":return tt(!0);case"build":return tt(!1);case"help":case"--help":return $t(),!0;default:return console.error(C(`Unknown command: '${t}'`)),$t(),!1}}async function ue(){try{await ce()||(process.exitCode=1)}catch(t){console.error(C(t)),process.exitCode=1}}ue();})();
