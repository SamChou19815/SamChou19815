#!/usr/bin/env node --unhandled-rejections=strict
/* eslint-disable */
// prettier-ignore
(()=>{var ce=Object.create,M=Object.defineProperty,me=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty,de=Object.getOwnPropertyNames,pe=Object.getOwnPropertyDescriptor;var fe=e=>M(e,"__esModule",{value:!0});var ge=(e,t,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of de(t))!ue.call(e,r)&&r!=="default"&&M(e,r,{get:()=>t[r],enumerable:!(o=pe(t,r))||o.enumerable});return e},c=e=>ge(fe(M(e!=null?ce(me(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var u=c(require("path")),Y=c(require("esbuild"));var v=c(require("path")),U=c(require("@yarnpkg/esbuild-plugin-pnp")),z=c(require("sass")),ye={name:"WebAppResolvePlugin",setup(e){e.onResolve({filter:/data:/},()=>({external:!0}))}},he={name:"sass",setup(e){e.onResolve({filter:/.\.(scss|sass)$/},async t=>({path:(0,v.resolve)((0,v.dirname)(t.importer),t.path)})),e.onLoad({filter:/.\.(scss|sass)$/},async t=>{let{css:o}=await new Promise((r,n)=>{(0,z.render)({file:t.path},(i,m)=>{i?n(i):r(m)})});return{contents:o.toString(),loader:"css",watchFiles:[t.path]}})}},Pe=[ye,he,(0,U.pnpPlugin)()],V=Pe;var Se=({isServer:e=!1,isProd:t=!1})=>({define:{__SERVER__:String(e),"process.env.NODE_ENV":t?'"production"':'"development"'},bundle:!0,minify:!1,target:"es2019",logLevel:"error",plugins:V}),R=Se;var S=c(require("path")),N=(0,S.join)(__dirname,"templates"),g=".temp",$=(0,S.join)(".temp","__server__.jsx"),y=(0,S.join)("src","pages"),C=(0,S.join)("build","__ssr.js"),K=(0,S.join)("build","__ssr.css"),B="build";var w=c(require("path"));var l=c(require("fs")),h=c(require("path")),b=(e,t)=>o=>o?t(o):e(),F=e=>new Promise((t,o)=>(0,l.readdir)(e,(r,n)=>r?o(r):t(n))),Q=async e=>Promise.all((await F(e)).flatMap(async t=>{let o=(0,h.join)(e,t);return await G(o)?[o,...await Q(o)]:[o]})).then(t=>t.flat()),W=async(e,t)=>{await d(t),await O(t),await Promise.all((await F(e)).map(async o=>{let r=(0,h.join)(e,o),n=(0,h.join)(t,o);await G(r)?await W(r,n):await H(r,n)}))},H=(e,t)=>new Promise((o,r)=>(0,l.copyFile)(e,t,b(o,r))),O=async e=>{let t=await F(e);await Promise.all(t.map(o=>D((0,h.join)(e,o))))},d=e=>new Promise((t,o)=>(0,l.mkdir)(e,{recursive:!0},b(t,o))),G=e=>new Promise((t,o)=>(0,l.lstat)(e,(r,n)=>r?o(r):t(n.isDirectory()))),X=async(e,t)=>t?(await Q(e)).map(o=>(0,h.relative)(e,o)).sort((o,r)=>o.localeCompare(r)):F(e);var D=e=>new Promise((t,o)=>{l.readFile!=null?(0,l.rm)(e,{recursive:!0,force:!0},b(t,o)):G(e).then(r=>r?(0,l.rmdir)(e,{recursive:!0},b(t,o)):(0,l.unlink)(e,b(t,o))).catch(r=>o(r))}),p=(e,t)=>new Promise((o,r)=>(0,l.writeFile)(e,t,b(o,r)));var Z="// @generated",q=e=>e.endsWith("index")?e.substring(0,e.length-(e.endsWith("/index")?6:5)):e,be=(e,t)=>{let o=q(e),r=t.filter(s=>s!==e).map(q),n=r.map((s,a)=>`const Component${a} = lazy(() => import('../src/pages/${s}'));`).join(""),i=r.map((s,a)=>`<Route exact path="/${s}"><Suspense fallback={null}><Component${a} /></Suspense></Route>`).join(""),m=`<Switch><Route exact path="/${o}"><Page /></Route>${i}</Switch>`;return`${Z}
import React,{Suspense,lazy}from'react';import{hydrate,render}from'react-dom';
import {BrowserRouter,Route,Switch}from'esbuild-scripts/__internal-components__/react-router';
import Document from '../src/pages/_document.tsx';import Page from '../src/pages/${o}';${n}
const element = <BrowserRouter><Document>${m}</Document></BrowserRouter>;const rootElement = document.getElementById('root');
if (rootElement.hasChildNodes()) hydrate(element, rootElement); else render(element, rootElement);
`},we=e=>`${Z}
import{createElement as h}from'react';import{renderToString}from'react-dom/server';import Helmet from 'esbuild-scripts/components/Head';
import Document from '../src/pages/_document.tsx';${e.map((t,o)=>`import Page${o} from '../src/pages/${t}';`).join("")}
const map = { ${e.map((t,o)=>`'${t}': Page${o}`).join(", ")} };
module.exports = (path) => ({ divHTML: renderToString(h(Document, {}, h(map[path]))), helmet: Helmet.renderStatic() });
`,Ee=async()=>(await d(y),(await X(y,!0)).map(t=>{switch((0,w.extname)(t)){case".js":case".jsx":case".ts":case".tsx":break;default:return null}return t.substring(0,t.lastIndexOf("."))}).filter(t=>t!=null&&!t.startsWith("_document"))),A=async()=>{let e=await Ee();return await d(g),await O(g),await Promise.all([...e.map(async t=>{let o=(0,w.join)(g,`${t}.jsx`);await d((0,w.dirname)(o)),await p(o,be(t,e))}),p($,we(e))]),e};var xe=(e,t)=>t?`<script type="module" src="/${e}"></script>`:`<script src="/${e}"></script>`,Te=(e,t)=>`<link rel="${t?"modulepreload":"preload"}" href="/${e}" />`,_e=(e,{esModule:t,noJS:o})=>{let r=[],n=[];e.forEach(s=>{!o&&s.endsWith("js")?r.push(s):s.endsWith("css")&&n.push(s)});let i=n.map(s=>`<link rel="stylesheet" href="/${s}" />`).join("")+r.map(s=>Te(s,t)).join(""),m=r.map(s=>xe(s,t)).join("");return{headLinks:i,bodyScriptLinks:m}},ee=(e,t)=>t==null?`<head>${e}</head>`:`<head>${[t.meta.toString(),t.title.toString(),t.link.toString(),t.script.toString(),e].join("")}</head>`,Re=(e,t,o)=>{let{headLinks:r,bodyScriptLinks:n}=_e(t,o);if(e==null){let _=ee(r),f=`<body><div id="root"></div>${n}</body>`;return`<!DOCTYPE html><html>${_}${f}</html>`}let{divHTML:i,helmet:m}=e,s=ee(r,m),a=`<body><div id="root">${i}</div>${n}</body>`;return`<!DOCTYPE html><html ${m.htmlAttributes.toString()}>${s}${a}</html>`},L=Re;var E=e=>process.stderr.isTTY?t=>`[${e}m${t}[0m`:t=>t,x=E(31),T=E(32),te=E(33),j=E(34),ze=E(35),Ve=E(36);var re=async e=>{let{outputFiles:t}=await(0,Y.build)({...R({isProd:!0}),entryPoints:e.map(r=>(0,u.join)(g,`${r}.jsx`)),assetNames:"assets/[name]-[hash]",chunkNames:"chunks/[name]-[hash]",entryNames:"[dir]/[name]-[hash]",minify:!0,format:"esm",splitting:!0,write:!1,outdir:"build"}),o=(0,u.resolve)("build");return await Promise.all(t.map(async r=>{await d((0,u.dirname)(r.path)),await p(r.path,r.contents)})),t.map(({path:r})=>(0,u.relative)(o,r))},ve=async()=>{await(0,Y.build)({...R({isServer:!0,isProd:!0}),entryPoints:[$],platform:"node",format:"cjs",outfile:C});try{return require((0,u.resolve)(C))}catch(e){return console.error(x("Unable to perform server side rendering since the server bundle is not correctly generated.")),console.error(x(e)),null}finally{await Promise.all([D(C),D(K)])}},$e=async({staticSiteGeneration:e,noJS:t})=>{let o=new Date().getTime();console.error(te("[i] Bundling..."));let r=await A();await W("public","build");let n,i;if(e){if([n,i]=await Promise.all([re(r),ve()]),i==null)return!1}else n=await re(r),i=null;let m=r.map(a=>{let _=n.filter(J=>J.startsWith("chunk")||J.startsWith(a)),f=L(i==null?void 0:i(a),_,{esModule:!0,noJS:t});return{entryPoint:a,html:f}});await Promise.all(m.map(async({entryPoint:a,html:_})=>{let f;a.endsWith("index")?f=(0,u.join)(B,`${a}.html`):f=(0,u.join)(B,a,"index.html"),await d((0,u.dirname)(f)),await p(f,_)}));let s=new Date().getTime()-o;return console.error(`\u26A1 ${T(`Build success in ${s}ms.`)}`),!0},I=$e;var P=c(require("path"));var Ce=async()=>{await d(y),await Promise.all([H((0,P.join)(N,"_document.tsx"),(0,P.join)(y,"_document.tsx")),H((0,P.join)(N,"index.tsx"),(0,P.join)(y,"index.tsx")),p((0,P.join)(y,"index.css"),""),p((0,P.join)("src","types.d.ts"),`/// <reference types="esbuild-scripts" />
`),d("public")]),console.error(T("esbuild-scripts app initialized."))},oe=Ce;var k=c(require("http")),ne=c(require("path")),se=c(require("esbuild"));var Fe=(e,t)=>{if(t==null||!t.startsWith("/"))return;let o=t.substring(1);return e.find(r=>r.endsWith("index")?[r,r.substring(0,r.length-5)].includes(o):r===o)},ie=e=>L(void 0,[`${e}.js`,`${e}.css`],{esModule:!1}),He=async()=>{let e=await A(),t=await(0,se.serve)({servedir:"public",port:19815},{...R({}),entryPoints:e.map(r=>(0,ne.join)(g,`${r}.jsx`)),sourcemap:"inline",outdir:"public"}),o=(0,k.createServer)((r,n)=>{let i=Fe(e,r.url);if(i!=null){n.writeHead(200,{"Content-Type":"text/html"}),n.end(ie(i));return}let m={hostname:t.host,port:t.port,path:r.url,method:r.method,headers:r.headers},s=(0,k.request)(m,a=>{if(a.statusCode===404){n.writeHead(200,{"Content-Type":"text/html"}),n.end(ie("index"));return}n.writeHead(a.statusCode||200,a.headers),a.pipe(n,{end:!0})});r.pipe(s,{end:!0})}).listen(3e3);console.error(`${T("Serving at")} ${j("http://localhost:3000")}`),await t.wait,o.close()},ae=He;function le(){console.error(j("Usage:")),console.error("- esbuild-script start: start the devserver."),console.error("- esbuild-script build: generate production build."),console.error("- esbuild-script ssg: generate static site."),console.error("- esbuild-script ssg --no-js: generate static site without JS."),console.error("- esbuild-script help: display command line usages.")}async function De(){let e=process.argv[2]||"";switch(e){case"init":return await oe(),!0;case"start":return await ae(),!0;case"ssg":return I({staticSiteGeneration:!0,noJS:process.argv.includes("--no-js")});case"build":return I({staticSiteGeneration:!1,noJS:!1});case"help":case"--help":return le(),!0;default:return console.error(x(`Unknown command: '${e}'`)),le(),!1}}async function Ae(){try{await De()||(process.exitCode=1)}catch(e){console.error(x(e)),process.exitCode=1}}Ae();})();
