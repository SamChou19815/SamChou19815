---
id: website-repo
title: Website Repository Setup
---

## Repository convention

- All configuration that can potentially affect the entire repository must be inside `configuration`
  directory.
- Packages installed and managed by latest Yarn v2 release.
- Must use Yarn v2's workspace feature.
- Root workspace has `format:check`, `lint`, `build`, `test` command.
- Managed by dev-sam's `monorail` tool.
- Each workspace follows a set of naming conventions.
  - Tooling workspace names must start with a predefined set of prefix.
  - Library workspace names must start with `lib-`
  - The rest workspaces are interpreted as deployable projects.
  - Each workspace must have a `compile` job.
  - Each project workspaces must have a `build` and `deploy` job, which will run in CI stage to
    deploy to production.
  - Each commit to master will be automatically pushed to production. No staging.

## GitHub Actions secrets

- `GH_TOKEN`
- `FIREBASE_TOKEN`
- `GCP_PROJECT_ID`
- `GCP_SERVICE_ACCOUNT_KEY`

## `monorail` monorepo tool

<!-- prettier-ignore-start -->
:::caution
This document might not be as updated as latest monorail build. Only documented features
here is guaranteed to be _relatively_ stable.

Currently, it is outdated. TODO for @dev-sam: fix it.
:::
<!-- prettier-ignore-end -->

### Installation

Download the self-contained
[code](https://github.com/SamChou19815/website/blob/master/packages/monorail/bin/monorail) checked
in the repo, and run it directly. You might need to reset the executable bit.

You can add `monorail` to your `PATH` so that you can directly run `monorail`.

### Configuration

Your root `package.json` should contain at least two sections:

```json
{
  // ...

  // Used for detecting workspace root.
  "workspaces": ["packages/*"],
  //
  "repoToolsConfiguration": {
    "binary": "relative/path/to/monorail/binary",
    "organizationName": "your-github-username-or-organization-name",
    "toolingPrefixes": ["anything-that-can-be-tooling-workspace-prefix"],
    "deploymentSecrets": ["name of github actions secret to be included as env-var in CD"]
  }

  // ...
}
```

### Static code generation

Running `monorail` or `monorail codegen` will generate following files:

- `.github/workflows/generated-*.yml`: a set of generated GitHub Action workflows that assume the
  repository layout described above and are dependency-aware.
- `.eslintignore`, `.prettierignore`: generated by appending `configuration/styleignore.additions`
  to `.gitignore`.
- `configuration/libraries.json`: a json array specifying the names of library workspaces.

### Repository dependency

`monorail` supports specifying another repository within the same GitHub organization as a
dependency. To declare that dependency, add the following lines to relevant workspace's
`package.json`:

```json
{
  // ...
  "githubRepositoryDependencies": ["name of the repo, excluding org name."]
  // ...
}
```

In addition, set `GH_TOKEN` in GitHub repository secrets to be your GitHub personal access token.

In local runs of `monorail`, it will have no effect. This declaration only instructs the CI to pull
relevant repositories before building the workspace.

`monorail` assumes a specific layout when pulling this dependency:

```console
- all-repos (name is irrelevant)
  - your-repository (same as the repo name on GitHub)
  - dependency-repository (same as the repo name on GitHub)
```

### Cached rebuild

Running `monorail rebuild` or `monorail r` will rebuild some generated code according to the
following rules:

If a workspace's `package.json` has `codegenConfiguration` with the format:

```json
{
  "sources": ["path to source directory", "or path to source file"],
  "output": "path to a single output file"
}
```

Then rebuild will invoke the `codegen` script in the workspace. It will only rebuild if one of the
specified source file's modified time is newer than the generated output.

### Cross-repository file syncing

To enable this feature, add a configuration with the following format:

```json title="configuration/sync-configuration.json"
{
  "name of target repo, without org name": {
    "relpath/to/source/in/current/repo": "relpath/to/destination/in/target/repo"
  }
}
```

Then run `monorail sync` or `monorail s` will copy the files according to your configuration, and
automatically make a pull request against that repo.

`monorail` will not attempt to fetch the repository for you. It's your responsibility to make the
repository there.
