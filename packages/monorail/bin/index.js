#!/usr/bin/env node
module.exports=(()=>{"use strict";var e={699:(e,n,t)=>{t.r(n);var o=t(129);var r=t(747);var i=t(622);var c=t(605);var s=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const u=e=>{const n=[];const t=[];e.trim().split("\n").forEach(e=>{const o=e.trim().split(/\s/).filter(e=>e.trim().length>0);if(o.length===0){return}const r=o[0];if(r==="A"||r==="M"){n.push(o[1])}else if(r==="D"){t.push(o[1])}else if(r.startsWith("R")){t.push(o[1]);n.push(o[2])}});return{changedFiles:n,deletedFiles:t}};const a=e=>new Promise((n,t)=>{c.get(e,e=>{let o="";e.on("data",e=>{o+=e});e.on("end",()=>{try{n(JSON.parse(o))}catch(e){t(e)}})}).on("error",e=>{t(e)})});const d=(e,n=".")=>s(void 0,void 0,void 0,function*(){const t=yield a(`http://localhost:19815/?since=${e}&pathPrefix=${n}`);const o=[];const r=[];t.forEach(({type:e,filename:n})=>{if(e==="changed"){o.push(n)}else{r.push(n)}});return{changedFiles:o,deletedFiles:r}});const l=(e,n=".")=>s(void 0,void 0,void 0,function*(){const t=(e,t)=>{const r=(0,o.spawnSync)("git",["diff",e,...t?[t]:[],"--name-status","--diff-filter=ADRM","--",n]).stdout.toString();return u(r)};if(process.env.CI){return t("HEAD^","HEAD")}try{return yield d(e,n)}catch(e){return t("origin/master")}});const f=l;var p=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const v=e=>p(void 0,void 0,void 0,function*(){const n=(0,r.existsSync)(e.lastestKnownGoodRunTimeFilename)?JSON.parse((0,r.readFileSync)(e.lastestKnownGoodRunTimeFilename).toString()):{};const t=yield e.needRerun(n);const o=yield Promise.all(t.map(t=>p(void 0,void 0,void 0,function*(){return[t,yield e.rerun(t,n)]})));const c=(new Date).getTime();const s=[];o.forEach(([e,t])=>{if(t){n[e]=c}else{s.push(e)}});(0,r.mkdirSync)((0,i.dirname)(e.lastestKnownGoodRunTimeFilename),{recursive:true});(0,r.writeFileSync)(e.lastestKnownGoodRunTimeFilename,JSON.stringify(n,undefined,2));return s});const h=v;var y=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const w=()=>y(void 0,void 0,void 0,function*(){const e=JSON.parse((0,r.readFileSync)("workspaces.json").toString());const n=yield h({lastestKnownGoodRunTimeFilename:(0,i.join)(".monorail","compile-cache.json"),needRerun:n=>y(void 0,void 0,void 0,function*(){const t=yield Promise.all(e.topologicallyOrdered.map(t=>y(void 0,void 0,void 0,function*(){const o=yield Promise.all(e.information[t].dependencyChain.map(t=>y(void 0,void 0,void 0,function*(){var o;const{changedFiles:r,deletedFiles:i}=yield f((o=n[t])!==null&&o!==void 0?o:0,e.information[t].workspaceLocation);return r.length+i.length!==0})));return[t,o.some(e=>e)]})));const o=t.filter(([,e])=>e).map(([e])=>e);if(o.length!==0){console.log(`[${o.join(", ")}] needs to be re-compiled!`)}return o}),rerun:e=>y(void 0,void 0,void 0,function*(){console.log(`Compiling \`${e}\`...`);const n=(0,o.spawn)("yarn",["workspace",e,"compile"]);return yield new Promise(e=>{n.on("exit",n=>e(n===0))})})});if(n.length===0){console.log("[âœ“] All workspaces have been successfully compiled!");return}throw new Error(`[x] [${n.join(", ")}] failed to exit with 0`)});const m=w;const _=()=>{let e=process.cwd();while(e!=="/"){const n=(0,i.join)(e,"package.json");if((0,r.existsSync)(n)&&(0,r.lstatSync)(n).isFile()){const t=JSON.parse((0,r.readFileSync)(n).toString());if(Array.isArray(t.workspaces)){return e}}e=(0,i.dirname)(e)}throw new Error("No root package.json found. Abort!")};const g=()=>{try{process.chdir(_())}catch(e){console.error(e.message);process.exit(1)}};var x=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const S=()=>x(void 0,void 0,void 0,function*(){try{g();switch(process.argv[2].toLowerCase()){case"compile":case"c":yield m();return;default:throw new Error}}catch(e){console.error(e);process.exit(1)}});S()},129:e=>{e.exports=require("child_process")},747:e=>{e.exports=require("fs")},605:e=>{e.exports=require("http")},622:e=>{e.exports=require("path")}};var n={};function __webpack_require__(t){if(n[t]){return n[t].exports}var o=n[t]={exports:{}};var r=true;try{e[t](o,o.exports,__webpack_require__);r=false}finally{if(r)delete n[t]}return o.exports}(()=>{__webpack_require__.r=(e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})})})();__webpack_require__.ab=__dirname+"/";return __webpack_require__(699)})();