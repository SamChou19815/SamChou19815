#!/usr/bin/env node
module.exports=(()=>{"use strict";var __webpack_modules__={167:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A_:()=>createJsonCodegenService,Kw:()=>runCodegenServicesIncrementally});var fs__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(747);var fs__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_0__);var path__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(622);var path__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(path__WEBPACK_IMPORTED_MODULE_1__);var typescript__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(34);var typescript__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(typescript__WEBPACK_IMPORTED_MODULE_2__);var lib_changed_files__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(614);var lib_incremental__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(570);var __awaiter=undefined&&undefined.__awaiter||function(e,n,t,r){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(r.next(e))}catch(e){o(e)}}function rejected(e){try{step(r["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())})};class CodegenInMemoryFilesystem{constructor(e){this.files=new Map(e)}fileExists(e){return this.files.has(e)}readFile(e){const n=this.files.get(e);if(n==null)throw new Error(`No such file: ${e}`);return n}writeFile(e,n){this.files.set(e,n)}deleteFile(e){this.files.delete(e)}}const CodegenRealFilesystem={fileExists:e=>(0,fs__WEBPACK_IMPORTED_MODULE_0__.existsSync)(e),readFile:e=>(0,fs__WEBPACK_IMPORTED_MODULE_0__.readFileSync)(e).toString(),writeFile:(e,n)=>{(0,fs__WEBPACK_IMPORTED_MODULE_0__.mkdirSync)((0,path__WEBPACK_IMPORTED_MODULE_1__.dirname)(e),{recursive:true});(0,fs__WEBPACK_IMPORTED_MODULE_0__.writeFileSync)(e,n)},deleteFile:e=>(0,fs__WEBPACK_IMPORTED_MODULE_0__.unlinkSync)(e)};const createJsonCodegenService=(e,n,t)=>({name:e,sourceFileIsRelevant:n,run:(e,n)=>t(e,JSON.parse(n))});const createTypeScriptCodegenService=(name,sourceFileIsRelevant,run)=>({name:name,sourceFileIsRelevant:sourceFileIsRelevant,run:(sourceFilename,source)=>{const transpiledModuleCode=typescript__WEBPACK_IMPORTED_MODULE_2__.transpile(source,{module:typescript__WEBPACK_IMPORTED_MODULE_2__.ModuleKind.CommonJS});const wrappedModuleCodeForEval=`((exports) => {\n      ${transpiledModuleCode}\n\n      return exports.default;\n    })({})`;const evaluatedSource=eval(wrappedModuleCodeForEval);return run(sourceFilename,evaluatedSource)}});const GENERATED_FILES_SOURCE_MAPPINGS_JSON=".codegen/mappings.json";const runCodegenServicesAccordingToFilesystemEvents=(e,n,t,r)=>{const o=r.fileExists(GENERATED_FILES_SOURCE_MAPPINGS_JSON)?JSON.parse(r.readFile(GENERATED_FILES_SOURCE_MAPPINGS_JSON)).mappings:{};n.forEach(e=>{var n;((n=o[e])!==null&&n!==void 0?n:[]).forEach(e=>{if(r.fileExists(e)){r.deleteFile(e)}});delete o[e]});const i=new Set;const s=(e,n)=>e.localeCompare(n);e.forEach(e=>{t.forEach(n=>{if(!n.sourceFileIsRelevant(e)){return}const t=r.readFile(e);const a=n.run(e,t);const c=new Set;a.forEach(({outputFilename:e,outputContent:n})=>{r.writeFile(e,n);i.add(e);c.add(e)});o[e]=Array.from(c).sort(s)})});r.writeFile(GENERATED_FILES_SOURCE_MAPPINGS_JSON,JSON.stringify({__type__:"@"+"generated",mappings:Object.fromEntries(Object.entries(o).sort(([e],[n])=>s(e,n)))},undefined,2));return Array.from(i).sort(s)};const runCodegenServicesIncrementally=(e,n)=>__awaiter(void 0,void 0,void 0,function*(){yield(0,lib_incremental__WEBPACK_IMPORTED_MODULE_4__.Z)({lastestKnownGoodRunTimeFilename:e,needRerun:()=>__awaiter(void 0,void 0,void 0,function*(){return["codegen"]}),rerun:(e,t)=>__awaiter(void 0,void 0,void 0,function*(){var e;const r=(e=t["codegen"])!==null&&e!==void 0?e:0;const{changedFiles:o,deletedFiles:i}=yield(0,lib_changed_files__WEBPACK_IMPORTED_MODULE_3__.Z)(r);runCodegenServicesAccordingToFilesystemEvents(o,i,n,CodegenRealFilesystem);return true})})})},614:(e,n,t)=>{t.d(n,{Z:()=>d});var r=t(129);var o=t.n(r);var i=t(605);var s=t.n(i);var a=undefined&&undefined.__awaiter||function(e,n,t,r){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(r.next(e))}catch(e){o(e)}}function rejected(e){try{step(r["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())})};const c=e=>{const n=[];const t=[];e.trim().split("\n").forEach(e=>{const r=e.trim().split(/\s/).filter(e=>e.trim().length>0);if(r.length===0){return}const o=r[0];if(o==="A"||o==="M"){n.push(r[1])}else if(o==="D"){t.push(r[1])}else if(o.startsWith("R")){t.push(r[1]);n.push(r[2])}});return{changedFiles:n,deletedFiles:t}};const _=e=>new Promise((n,t)=>{i.get(e,e=>{let r="";e.on("data",e=>{r+=e});e.on("end",()=>{try{n(JSON.parse(r))}catch(e){t(e)}})}).on("error",e=>{t(e)})});const l=(e,n=".")=>a(void 0,void 0,void 0,function*(){const t=yield _(`http://localhost:19815/?since=${e}&pathPrefix=${n}`);const r=[];const o=[];t.forEach(({type:e,filename:n})=>{if(e==="changed"){r.push(n)}else{o.push(n)}});return{changedFiles:r,deletedFiles:o}});const u=(e,n=".")=>a(void 0,void 0,void 0,function*(){const t=(e,t)=>{const o=(0,r.spawnSync)("git",["diff",e,...t?[t]:[],"--name-status","--diff-filter=ADRM","--",n]).stdout.toString();return c(o)};if(process.env.CI){return t("HEAD^","HEAD")}try{return yield l(e,n)}catch(e){return t("origin/master")}});const d=u},570:(e,n,t)=>{t.d(n,{Z:()=>_});var r=t(747);var o=t.n(r);var i=t(622);var s=t.n(i);var a=undefined&&undefined.__awaiter||function(e,n,t,r){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(r.next(e))}catch(e){o(e)}}function rejected(e){try{step(r["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())})};const c=e=>a(void 0,void 0,void 0,function*(){const n=(0,r.existsSync)(e.lastestKnownGoodRunTimeFilename)?JSON.parse((0,r.readFileSync)(e.lastestKnownGoodRunTimeFilename).toString()):{};const t=yield e.needRerun(n);const o=yield Promise.all(t.map(t=>a(void 0,void 0,void 0,function*(){return[t,yield e.rerun(t,n)]})));const s=(new Date).getTime();const c=[];o.forEach(([e,t])=>{if(t){n[e]=s}else{c.push(e)}});(0,r.mkdirSync)((0,i.dirname)(e.lastestKnownGoodRunTimeFilename),{recursive:true});(0,r.writeFileSync)(e.lastestKnownGoodRunTimeFilename,JSON.stringify(n,undefined,2));return c});const _=c},955:(e,n,t)=>{t.r(n);var r=t(747);var o=t(622);const i=()=>{let e=process.cwd();while(e!=="/"){const n=(0,o.join)(e,"package.json");if((0,r.existsSync)(n)&&(0,r.lstatSync)(n).isFile()){const t=JSON.parse((0,r.readFileSync)(n).toString());if(Array.isArray(t.workspaces)){return e}}e=(0,o.dirname)(e)}throw new Error("No root package.json found. Abort!")};const s=()=>{try{process.chdir(i())}catch(e){console.error(e.message);process.exit(1)}};var a=t(129);var c=t(614);var _=t(570);var l=undefined&&undefined.__awaiter||function(e,n,t,r){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(r.next(e))}catch(e){o(e)}}function rejected(e){try{step(r["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())})};const u=JSON.parse((0,r.readFileSync)("workspaces.json").toString());const d={lastestKnownGoodRunTimeFilename:(0,o.join)(".monorail","compile-cache.json"),needRerun:e=>l(void 0,void 0,void 0,function*(){const n=yield Promise.all(u.topologicallyOrdered.map(n=>l(void 0,void 0,void 0,function*(){const t=yield Promise.all(u.information[n].dependencyChain.map(n=>l(void 0,void 0,void 0,function*(){var t;const{changedFiles:r,deletedFiles:o}=yield(0,c.Z)((t=e[n])!==null&&t!==void 0?t:0,u.information[n].workspaceLocation);return r.length+o.length!==0})));return[n,t.some(e=>e)]})));const t=n.filter(([,e])=>e).map(([e])=>e);if(t.length!==0){console.log(`[${t.join(", ")}] needs to be re-compiled!`)}return t}),rerun:e=>l(void 0,void 0,void 0,function*(){console.log(`Compiling \`${e}\`...`);const n=(0,a.spawn)("yarn",["workspace",e,"compile"]);return yield new Promise(e=>{n.on("exit",n=>e(n===0))})})};const p=()=>l(void 0,void 0,void 0,function*(){const e=yield(0,_.Z)(d);if(e.length===0){console.log("[âœ“] All workspaces have been successfully compiled!");return}throw new Error(`[x] [${e.join(", ")}] failed to exit with 0`)});const f=p;var m=t(167);const w=(e,n={})=>({type:"use-action",actionName:e,actionArguments:n});const h=(e,n)=>({type:"run",stepName:e,command:n});const v=e=>{switch(e.type){case"use-action":{const n=`      - uses: ${e.actionName}\n`;if(Object.keys(e.actionArguments).length===0){return n}const t=Object.entries(e.actionArguments).map(([e,n])=>{const t=n.split("\n");if(t.length===1){return`          ${e}: ${t[0]}`}return`          ${e}: |\n${t.map(e=>`            ${e}`).join("\n")}`}).join("\n");return`${n}        with:\n${t}\n`}case"run":{const n=`      - name: ${e.stepName}\n`;const t=e.command.split("\n");if(t.length===1){return`${n}        run: ${t[0]}\n`}return`${n}        run: |\n${t.map(e=>`          ${e}\n`).join("")}`}default:throw new Error}};const E=({jobName:e,jobSteps:n})=>{return`  ${e}:\n    runs-on: ubuntu-latest\n    steps:\n${n.map(v).join("")}`};const y=({workflowName:e,workflowtrigger:{triggerPaths:n,masterBranchOnly:t},workflowSecrets:r=[],workflowJobs:o})=>{const i=`# @generated\n\nname: ${e}\non:\n  push:\n    paths:\n${n.map(e=>`      - '${e}'\n`).join("")}${t?`    branches:\n      - master\n`:""}${r.length>0?`env:\n${r.map(e=>`  ${e}: \${{ secrets.${e} }}`).join("\n")}\n`:""}\njobs:\n${o.map(E).join("")}`;return i};const g=w("actions/checkout@v2");const b=w("actions/setup-node@v2-beta");const O=w("actions/cache@v2",{path:".yarn/cache\n.pnp.js",key:"yarn-berry-${{ hashFiles('**/yarn.lock') }}","restore-keys":"yarn-berry-"});const S=[g,b,O,h("Yarn Install","yarn install --immutable")];const k=e=>{const n=n=>{var t,i;return((i=(t=JSON.parse((0,r.readFileSync)((0,o.join)(e.information[n].workspaceLocation,"package.json")).toString()))===null||t===void 0?void 0:t.scripts)===null||i===void 0?void 0:i.deploy)!=null};return Object.fromEntries([...e.topologicallyOrdered.filter(n).map(n=>{const t=`cd-${n}`;return[t,{workflowName:`CD ${n}`,workflowtrigger:{triggerPaths:[...e.information[n].dependencyChain.map(n=>`${e.information[n].workspaceLocation}/**`),"configuration/**",`.github/workflows/generated-*-${n}.yml`],masterBranchOnly:true},workflowSecrets:["FIREBASE_TOKEN"],workflowJobs:[{jobName:"deploy",jobSteps:[...S,h("Build",`yarn workspace ${n} build`),h("Install firebase-tools","sudo npm install -g firebase-tools"),h("Deploy",`yarn workspace ${n} deploy`)]}]}]})])};const P=()=>["general",{workflowName:"General",workflowtrigger:{triggerPaths:["**"],masterBranchOnly:false},workflowJobs:[{jobName:"lint",jobSteps:[...S,h("Codegen",`yarn node packages/monorail/bin/index.js codegen`),h("Check changed","if [[ `git status --porcelain` ]]; then exit 1; fi"),h("Format Check","yarn format:check"),h("Lint","yarn lint")]},{jobName:"build",jobSteps:[w("actions/checkout@v2",{"fetch-depth":"2"}),b,O,h("Yarn Install","yarn install --immutable"),h("Build","yarn compile")]},{jobName:"test",jobSteps:[...S,h("Test","yarn test")]}]}];const C=(0,m.A_)("GitHub Actions Workflows Codegen",e=>e==="workspaces.json",(e,n)=>{return[P(),...Object.entries(k(n))].map(([e,n])=>({outputFilename:`.github/workflows/generated-${e}.yml`,outputContent:y(n)}))});const M={name:"Ignore Files Codegen",sourceFileIsRelevant:e=>e===".gitignore",run:(e,n)=>{const t=`# ${"@"+"generated"}\n\n${n}\n\n# additions\n.yarn\n**/bin/`;return[{outputFilename:".eslintignore",outputContent:t},{outputFilename:".prettierignore",outputContent:t}]}};const D=[C,M];const j=D;var F=undefined&&undefined.__awaiter||function(e,n,t,r){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,o){function fulfilled(e){try{step(r.next(e))}catch(e){o(e)}}function rejected(e){try{step(r["throw"](e))}catch(e){o(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((r=r.apply(e,n||[])).next())})};s();const A=()=>{const e=process.argv.slice(2);if(e.length===0){return"CODEGEN"}switch(e[0].toLowerCase()){case"codegen":return"CODEGEN";case"compile":case"c":return"COMPILE";case"no-changed":case"nc":return"NO_CHANGED";default:throw new Error(`Unknown command: ${e[0]}`)}};const R=()=>F(void 0,void 0,void 0,function*(){try{switch(A()){case"CODEGEN":{yield(0,m.Kw)((0,o.join)(".monorail","codegen-cache.json"),j);return}case"COMPILE":yield f();return;case"NO_CHANGED":{const e=(0,a.spawnSync)("git",["status","--porcelain"],{shell:true}).stdout.toString();if(e.length===0)return;throw new Error(`There are changed files! Generated files might be out-of-sync!\n${e.trimEnd()}`)}default:throw new Error}}catch(e){console.error(e);process.exit(1)}});R()},129:e=>{e.exports=require("child_process")},747:e=>{e.exports=require("fs")},605:e=>{e.exports=require("http")},622:e=>{e.exports=require("path")},34:e=>{e.exports=require("typescript")}};var __webpack_module_cache__={};function __webpack_require__(e){if(__webpack_module_cache__[e]){return __webpack_module_cache__[e].exports}var n=__webpack_module_cache__[e]={exports:{}};var t=true;try{__webpack_modules__[e](n,n.exports,__webpack_require__);t=false}finally{if(t)delete __webpack_module_cache__[e]}return n.exports}(()=>{__webpack_require__.n=(e=>{var n=e&&e.__esModule?()=>e["default"]:()=>e;__webpack_require__.d(n,{a:n});return n})})();(()=>{__webpack_require__.d=((e,n)=>{for(var t in n){if(__webpack_require__.o(n,t)&&!__webpack_require__.o(e,t)){Object.defineProperty(e,t,{enumerable:true,get:n[t]})}}})})();(()=>{__webpack_require__.o=((e,n)=>Object.prototype.hasOwnProperty.call(e,n))})();(()=>{__webpack_require__.r=(e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})})})();__webpack_require__.ab=__dirname+"/";return __webpack_require__(955)})();