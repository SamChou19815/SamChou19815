#!/usr/bin/env node
module.exports=(()=>{"use strict";var e={699:(e,n,t)=>{t.r(n);var o=t(747);var r=t(622);const i=()=>{let e=process.cwd();while(e!=="/"){const n=(0,r.join)(e,"package.json");if((0,o.existsSync)(n)&&(0,o.lstatSync)(n).isFile()){const t=JSON.parse((0,o.readFileSync)(n).toString());if(Array.isArray(t.workspaces)){return e}}e=(0,r.dirname)(e)}throw new Error("No root package.json found. Abort!")};const c=()=>{try{process.chdir(i())}catch(e){console.error(e.message);process.exit(1)}};var s=t(129);var u=t(605);var a=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const d=e=>{const n=[];const t=[];e.trim().split("\n").forEach(e=>{const o=e.trim().split(/\s/).filter(e=>e.trim().length>0);if(o.length===0){return}const r=o[0];if(r==="A"||r==="M"){n.push(o[1])}else if(r==="D"){t.push(o[1])}else if(r.startsWith("R")){t.push(o[1]);n.push(o[2])}});return{changedFiles:n,deletedFiles:t}};const l=e=>new Promise((n,t)=>{u.get(e,e=>{let o="";e.on("data",e=>{o+=e});e.on("end",()=>{try{n(JSON.parse(o))}catch(e){t(e)}})}).on("error",e=>{t(e)})});const f=(e,n=".")=>a(void 0,void 0,void 0,function*(){const t=yield l(`http://localhost:19815/?since=${e}&pathPrefix=${n}`);const o=[];const r=[];t.forEach(({type:e,filename:n})=>{if(e==="changed"){o.push(n)}else{r.push(n)}});return{changedFiles:o,deletedFiles:r}});const p=(e,n=".")=>a(void 0,void 0,void 0,function*(){const t=(e,t)=>{const o=(0,s.spawnSync)("git",["diff",e,...t?[t]:[],"--name-status","--diff-filter=ADRM","--",n]).stdout.toString();return d(o)};if(process.env.CI){return t("HEAD^","HEAD")}try{return yield f(e,n)}catch(e){return t("origin/master")}});const v=p;var h=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const y=e=>h(void 0,void 0,void 0,function*(){const n=(0,o.existsSync)(e.lastestKnownGoodRunTimeFilename)?JSON.parse((0,o.readFileSync)(e.lastestKnownGoodRunTimeFilename).toString()):{};const t=yield e.needRerun(n);const i=yield Promise.all(t.map(t=>h(void 0,void 0,void 0,function*(){return[t,yield e.rerun(t,n)]})));const c=(new Date).getTime();const s=[];i.forEach(([e,t])=>{if(t){n[e]=c}else{s.push(e)}});(0,o.mkdirSync)((0,r.dirname)(e.lastestKnownGoodRunTimeFilename),{recursive:true});(0,o.writeFileSync)(e.lastestKnownGoodRunTimeFilename,JSON.stringify(n,undefined,2));return s});const w=y;var m=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const _=JSON.parse((0,o.readFileSync)("workspaces.json").toString());const g={lastestKnownGoodRunTimeFilename:(0,r.join)(".monorail","compile-cache.json"),needRerun:e=>m(void 0,void 0,void 0,function*(){const n=yield Promise.all(_.topologicallyOrdered.map(n=>m(void 0,void 0,void 0,function*(){const t=yield Promise.all(_.information[n].dependencyChain.map(n=>m(void 0,void 0,void 0,function*(){var t;const{changedFiles:o,deletedFiles:r}=yield v((t=e[n])!==null&&t!==void 0?t:0,_.information[n].workspaceLocation);return o.length+r.length!==0})));return[n,t.some(e=>e)]})));const t=n.filter(([,e])=>e).map(([e])=>e);if(t.length!==0){console.log(`[${t.join(", ")}] needs to be re-compiled!`)}return t}),rerun:e=>m(void 0,void 0,void 0,function*(){console.log(`Compiling \`${e}\`...`);const n=(0,s.spawn)("yarn",["workspace",e,"compile"]);return yield new Promise(e=>{n.on("exit",n=>e(n===0))})})};const x=()=>m(void 0,void 0,void 0,function*(){const e=yield w(g);if(e.length===0){console.log("[âœ“] All workspaces have been successfully compiled!");return}throw new Error(`[x] [${e.join(", ")}] failed to exit with 0`)});const S=x;var j=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};c();const b=()=>j(void 0,void 0,void 0,function*(){try{switch(process.argv[2].toLowerCase()){case"compile":case"c":yield S();return;default:throw new Error}}catch(e){console.error(e);process.exit(1)}});b()},129:e=>{e.exports=require("child_process")},747:e=>{e.exports=require("fs")},605:e=>{e.exports=require("http")},622:e=>{e.exports=require("path")}};var n={};function __webpack_require__(t){if(n[t]){return n[t].exports}var o=n[t]={exports:{}};var r=true;try{e[t](o,o.exports,__webpack_require__);r=false}finally{if(r)delete n[t]}return o.exports}(()=>{__webpack_require__.r=(e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})})})();__webpack_require__.ab=__dirname+"/";return __webpack_require__(699)})();