#!/usr/bin/env node
module.exports=(()=>{"use strict";var e={272:(e,n,t)=>{t.r(n);const o=require("child_process");const r=require("fs");const i=require("path");const s=e=>e!=null;function assertNotNull(e){if(e==null){throw new Error(`Value is asserted to be not null, but it is ${e}.`)}}const c=e=>{assertNotNull(e);return e};const u=e=>{const n=[];const t=[];e.trim().split("\n").forEach(e=>{const o=e.trim().split(/\s/).filter(e=>e.trim().length>0);if(o.length===0){return}const[r,i,s]=o;assertNotNull(r);assertNotNull(i);if(r==="A"||r==="M"){n.push(i)}else if(r==="D"){t.push(i)}else if(r.startsWith("R")){t.push(i);assertNotNull(s);n.push(s)}});return{changedFiles:n,deletedFiles:t}};const l=(e=".")=>{const n=(n,t)=>{const r=(0,o.spawnSync)("git",["diff",n,...t?[t]:[],"--name-status","--diff-filter=ADRM","--",e]).stdout.toString();return u(r)};if(process.env.CI){return n("HEAD^","HEAD")}return n("origin/master")};const d=l;var a=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const f=e=>a(void 0,void 0,void 0,function*(){const n=(0,r.existsSync)(e.lastestKnownGoodRunTimeFilename)?JSON.parse((0,r.readFileSync)(e.lastestKnownGoodRunTimeFilename).toString()):{};const t=yield e.needRerun(n);const o=yield Promise.all(t.map(t=>a(void 0,void 0,void 0,function*(){return[t,yield e.rerun(t,n)]})));const s=(new Date).getTime();const c=[];o.forEach(([e,t])=>{if(t){n[e]=s}else{c.push(e)}});(0,r.mkdirSync)((0,i.dirname)(e.lastestKnownGoodRunTimeFilename),{recursive:true});(0,r.writeFileSync)(e.lastestKnownGoodRunTimeFilename,JSON.stringify(n,undefined,2));return c});const p=f;var v=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const y=e=>JSON.parse((0,r.readFileSync)(e).toString());const w=(e,n)=>v(void 0,void 0,void 0,function*(){var t,o;const r=t=>{var o,r;return(0,i.dirname)(t)!==(0,i.join)((r=(o=e.information[n])===null||o===void 0?void 0:o.workspaceLocation)!==null&&r!==void 0?r:".","bin")};const s=((o=(t=e.information[n])===null||t===void 0?void 0:t.dependencyChain)!==null&&o!==void 0?o:[]).map(n=>{var t,o;const{changedFiles:i,deletedFiles:s}=d((o=(t=e.information[n])===null||t===void 0?void 0:t.workspaceLocation)!==null&&o!==void 0?o:".");return i.some(r)||s.some(r)});return s.some(e=>e)});const m=(e,n,t)=>v(void 0,void 0,void 0,function*(){const o=yield Promise.all(e.topologicallyOrdered.map(o=>v(void 0,void 0,void 0,function*(){if(!t(e,o)){return[o,false]}if(n(e,o)){return[o,true]}const r=yield w(e,o);return[o,r]})));return o.filter(([,e])=>e).map(([e])=>e)});const h=(e,n,t)=>v(void 0,void 0,void 0,function*(){const r=y("workspaces.json");const s=yield p({lastestKnownGoodRunTimeFilename:(0,i.join)(".monorail",`${e}-cache.json`),needRerun:()=>v(void 0,void 0,void 0,function*(){const o=yield m(r,n,t);if(o.length!==0){console.log(`[${o.join(", ")}] needs to be ${e}d!`)}return o}),rerun:n=>v(void 0,void 0,void 0,function*(){console.log(`Running \`yarn workspace ${n} ${e}\`...`);const t=(0,o.spawn)("yarn",["workspace",n,e]);return yield new Promise(e=>{t.on("exit",n=>e(n===0))})})});if(s.length===0){console.log(`[âœ“] All workspaces have been successfully ${e}d!`);return}throw new Error(`[x] [${s.join(", ")}] failed to exit with 0`)});const _=()=>v(void 0,void 0,void 0,function*(){return h("compile",()=>false,()=>true)});const g=_;const S=()=>{let e=process.cwd();while(e!=="/"){const n=(0,i.join)(e,"package.json");if((0,r.existsSync)(n)&&(0,r.lstatSync)(n).isFile()){const t=JSON.parse((0,r.readFileSync)(n).toString());if(Array.isArray(t.workspaces)){return e}}e=(0,i.dirname)(e)}throw new Error("No root package.json found. Abort!")};const x=()=>{try{process.chdir(S())}catch(e){console.error(e.message);process.exit(1)}};var b=undefined&&undefined.__awaiter||function(e,n,t,o){function adopt(e){return e instanceof t?e:new t(function(n){n(e)})}return new(t||(t=Promise))(function(t,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?t(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,n||[])).next())})};const j=()=>b(void 0,void 0,void 0,function*(){try{x();yield g()}catch(e){console.error(e);process.exit(1)}});j()}};var n={};function __webpack_require__(t){if(n[t]){return n[t].exports}var o=n[t]={exports:{}};var r=true;try{e[t](o,o.exports,__webpack_require__);r=false}finally{if(r)delete n[t]}return o.exports}(()=>{__webpack_require__.r=(e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})})})();__webpack_require__.ab=__dirname+"/";return __webpack_require__(272)})();