// @generated
/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-monorail",
factory: function (require) {
var plugin=(()=>{var _=Object.create;var d=Object.defineProperty,B=Object.defineProperties,N=Object.getOwnPropertyDescriptor,G=Object.getOwnPropertyDescriptors,H=Object.getOwnPropertyNames,g=Object.getOwnPropertySymbols,M=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var E=(n,e,o)=>e in n?d(n,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[e]=o,x=(n,e)=>{for(var o in e||(e={}))k.call(e,o)&&E(n,o,e[o]);if(g)for(var o of g(e))W.call(e,o)&&E(n,o,e[o]);return n},Y=(n,e)=>B(n,G(e)),F=n=>d(n,"__esModule",{value:!0});var m=n=>{if(typeof require!="undefined")return require(n);throw new Error('Dynamic require of "'+n+'" is not supported')};var T=(n,e)=>{var o={};for(var r in n)k.call(n,r)&&e.indexOf(r)<0&&(o[r]=n[r]);if(n!=null&&g)for(var r of g(n))e.indexOf(r)<0&&W.call(n,r)&&(o[r]=n[r]);return o};var q=(n,e)=>{F(n);for(var o in e)d(n,o,{get:e[o],enumerable:!0})},U=(n,e,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of H(e))!k.call(n,r)&&r!=="default"&&d(n,r,{get:()=>e[r],enumerable:!(o=N(e,r))||o.enumerable});return n},u=n=>U(F(d(n!=null?_(M(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var rn={};q(rn,{default:()=>on});var v=u(m("fs")),J=u(m("clipanion"));var y=u(m("child_process")),$=u(m("fs")),h=u(m("path"));var l=n=>process.stderr.isTTY?e=>`[${n}m${e}[0m`:e=>e,I=l(31),b=l(32),L=l(33),R=l(34),A=l(35),sn=l(36);var V=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];async function C(n,e){if(!process.stderr.isTTY)return e();let o=0,r=new Date().getTime(),i=setInterval(()=>{let a=`${((new Date().getTime()-r)/1e3).toFixed(1)}s`,s=n(a),c=V[o%10];process.stderr.write(L(`${s} ${c}\r`)),o+=1},process.stderr.isTTY?40:1e3),t=await e();return clearInterval(i),t}var z=n=>{let e=(o,r)=>{let i=(0,y.spawnSync)("git",["diff",o,...r?[r]:[],"--name-only","--",n]).stdout.toString().trim();return i===""?[]:i.split(`
`)};return process.env.CI?e("HEAD^","HEAD"):e("origin/main")},K=n=>JSON.parse((0,$.readFileSync)(n).toString()),Q=(n,e)=>{var i,t;let o=a=>{var s,c;return(0,h.dirname)(a)!==(0,h.join)((c=(s=n.information[e])==null?void 0:s.workspaceLocation)!=null?c:".","bin")};return((t=(i=n.information[e])==null?void 0:i.dependencyChain)!=null?t:[]).some(a=>{var p,f;let s=(f=(p=n.information[a])==null?void 0:p.workspaceLocation)!=null?f:".";return z(s).some(o)})},X=n=>n.topologicallyOrdered.map(e=>{let o=Q(n,e);return[e,o]}).filter(([,e])=>e).map(([e])=>e),Z=async()=>{let n=K("workspaces.json"),e=X(n);e.forEach(t=>{console.error(R(`[i] \`${t}\` needs to be recompiled.`))});let o=await C(t=>`[?] Compiling (${t})`,()=>Promise.all(e.map(t=>{let a=(0,y.spawn)("yarn",["workspace",t,"compile"],{shell:!0,stdio:["ignore","pipe","ignore"]}),s="";return a.stdout.on("data",c=>{s+=c.toString()}),new Promise(c=>{a.on("exit",p=>c([t,p===0,s]))})}))),r=o.map(t=>t[2]).join(""),i=o.filter(t=>!t[1]).map(t=>t[0]);return i.length===0?(console.error(b("[\u2713] All workspaces have been successfully compiled!")),!0):(console.error(A("[!] Compilation finished with some errors.")),console.error(r.trim()),i.forEach(t=>{console.error(I(`[x] \`${t}\` failed to exit with 0.`))}),!1)},D=Z;function P(n){return n.scope==null?n.name:`@${n.scope}/${n.name}`}function nn(n){let e=new Map;return n.workspaces.forEach(o=>{let r=o.relativeCwd;if(r===".")return;let i=P(o.locator),t=Array.from(o.getRecursiveWorkspaceDependencies()).map(a=>P(a.locator));e.set(i,{workspaceLocation:r,dependencies:t})}),e}function j(n,e){let o=[],r=[],i=new Set,t=new Set;function a(s){var p;if(t.has(s)){if(!i.has(s))return;r.push(s);let f=r.indexOf(s),O=r.slice(f,r.length).join(" -> ");throw new Error(`Cyclic dependency detected: ${O}`)}let c=(p=n.get(s))==null?void 0:p.dependencies;if(c==null)throw new Error(`Workspace ${e} is not found!`);t.add(s),r.push(s),i.add(s),c.forEach(a),i.delete(s),r.pop(),o.push(s)}return a(e),o}function S(n){let e=nn(n);return{__type__:"@generated",information:Object.fromEntries(Array.from(e.entries()).map(t=>{var[o,a]=t,s=a,{dependencies:r}=s,i=T(s,["dependencies"]);return[o,Y(x({},i),{dependencyChain:j(e,o)})]}).sort(([o],[r])=>o.localeCompare(r))),topologicallyOrdered:(()=>{let o=[],r=new Set;return Array.from(e.keys()).forEach(i=>{j(e,i).forEach(a=>{r.has(a)||(o.push(a),r.add(a))})}),o})()}}var w=class extends J.Command{async execute(){return await D()?0:1}};w.paths=[["c"]];var en={hooks:{afterAllInstalled(n){(0,v.writeFileSync)("workspaces.json",`${JSON.stringify(S(n),void 0,2)}
`)}},commands:[w]},on=en;return rn;})();
return plugin;
}
};
