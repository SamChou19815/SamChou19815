#!/bin/bash

# latest commit
LATEST_COMMIT=$(git rev-parse HEAD)

function deployIfChanged() {
    FOLDER_COMMIT=$(git log -1 --format=format:%H --full-diff ${1})
    if [ $FOLDER_COMMIT = $LATEST_COMMIT ]; then
        echo "${1} has changed since the last commit. Prepare deployment"
        cd ${1}
        yarn
        yarn build
        cd ../
        ./node_modules/.bin/firebase deploy --token=$FIREBASE_TOKEN --non-interactive --only hosting:${1}
    fi
}

# install deployment tools
yarn init -y
yarn add --dev firebase-tools

deployIfChanged 'main-site-frontend'
deployIfChanged 'samlang-demo-frontend'
deployIfChanged 'ten-web-frontend'

# cleanup
rm -rf node_modules/
rm package.json yarn.lock
